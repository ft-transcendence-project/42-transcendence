<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>test</title>
    <script>
<!--      domを読み込んでから-->
        document.addEventListener("DOMContentLoaded", function() {
            let interval;
            // websocketの接続先
            const url = "ws://" + window.location.host + "/ws/websocket/"
            const ws = new WebSocket(url);
            console.log(url);

            // websocketでの接続が確立されたときに動く
            ws.onopen = function() {
                console.log("Connected");
            };

            ws.onclose = function(event) {
                console.log("Disconnected");
            };
            //websocketでメッセージを受信されたら動く
            ws.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log("Received message:", data);

                document.getElementById("left_paddle_y").innerText = "left_paddle_y: " + data.left_paddle_y;
                document.getElementById("right_paddle_y").innerText = "right_paddle_y: " + data.right_paddle_y;
                document.getElementById("ball_x").innerText = "ball_x: " + data.ball_x;
                document.getElementById("ball_y").innerText = "ball_y: " + data.ball_y;
            };

            const keyStates = { left: false, right: false };
            //ボタンを長押ししたら送り続ける
            document.addEventListener("keydown", function(event) {
                let message = null;
                if (event.key === "D" || event.key === "d") {
                    message = { key: "D", action: "pressed", paddle: "left" };
                } else if (event.key === "E" || event.key === "e") {
                    message = { key: "E", action: "pressed", paddle: "left" };
                } else if (event.key === "I" || event.key === "i") {
                    message = { key: "I", action: "pressed", paddle: "right" };
                } else if (event.key === "K" || event.key === "k") {
                    message = { key: "K", action: "pressed", paddle: "right" };
                }

                if (message && message.paddle === "left" && !keyStates.left) {
                    keyStates.left = true;
                    leftinterval = setInterval(function() {
                        sendMessage(message);
                    }, 100);
                }
                if (message && message.paddle === "right" && !keyStates.right) {
                    keyStates.right = true;
                    rightinterval = setInterval(function() {
                        sendMessage(message);
                    }, 100);
                }
            });

            //ボタンを離したら送るのをやめる
            document.addEventListener("keyup",function(event) {
                if (event.key === "E" || event.key === "e" || event.key === "D" || event.key === "d") {
                    clearInterval(leftinterval);  // メッセージ送信の間隔を止める
                    keyStates.left = false;
                }
                else if (event.key === "I" || event.key === "i" || event.key === "K" || event.key === "k") {
                    clearInterval(rightinterval);  // メッセージ送信の間隔を止める
                    keyStates.right = false;
                }
            });

            function sendMessage(message) {
                ws.send(JSON.stringify(message));
            }
});

    </script>
</head>
<body>
    <h1 id="left_paddle_y">left_paddle_y: 0</h1>
    <h1 id="right_paddle_y">right_paddle_y: 0</h1>
    <h1 id="ball_x">ball_x: 0</h1>
    <h1 id="ball_y">ball_y: 0</h1>
</body>
</html>
